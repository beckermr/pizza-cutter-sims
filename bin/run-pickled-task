#!/usr/bin/env python
import os
import sys
import joblib
import subprocess


def main():
    input_file = sys.argv[1]
    output_file = sys.argv[2]
    logfile = sys.argv[3]

    try:
        rd = joblib.load(input_file)

        try:
            res = rd[0](*rd[1], **rd[2])
        except Exception as e:
            res = e

        joblib.dump(res, output_file)
    finally:
        if not os.path.exists(output_file):
            joblib.dump(RuntimeError("job failed - see %s" % logfile), output_file)
        subprocess.run("touch " + output_file + ".done", shell=True, check=True)


if __name__ == '__main__':
    main()
